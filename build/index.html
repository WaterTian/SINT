<!DOCTYPE html>
<html>

<head>
    <title>SINT</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <style>
        body {
        font-family: "Inconsolata", monospace;
        background-color: #dedede;
        margin: 0px;
        overflow: hidden;
    }

    #webglContainer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 1;
    }

    #videoContainer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 100;
        display: none;
    }
    #videoInput {
        border:none;
        outline:medium;
        background:none;
        text-align:center;
        position: absolute;
        top: 2vw;
        left: 40vw;
        width: 20vw;
        z-index: 110;
    }
    </style>
</head>

<body>

    <div id="webglContainer"> </div>
    <div id="videoContainer"> </div>
    <input id="videoInput" type="text" name="videoTxt" value="sint.js" readonly="readonly">
    <script src="./vconsole.min.js"></script>
    <script src="./sint.js"></script>
    <script>
    var vConsole = new VConsole();


    const config = {
        domElement: document.querySelector('#webglContainer'), // 画布容器
        initWidth: 750,
        initHeight: 1334,
        showFPS: false,
        backgroundColor: 0x2a3145,
    };

    const assets1 = {
        bg: './assets/bg.png',
        pic1: './assets/pic1.png',
        fish1: './assets/displacement_fish1.png',
        fish2: './assets/displacement_fish2.png',
        fish3: './assets/displacement_fish3.png',
        fish4: './assets/displacement_fish4.png',
        sound0: './assets/sound/bg.mp3',
        sound1: './assets/sound/s1.mp3',
        sound2: './assets/sound/s2.mp3',
    }
    const assets2 = {
        icon1: './assets/icon1.png',
        pic2: './assets/pic2.png',
        fighter: './assets/fighter.json',
        spineboy: './assets/spineboy.json',
    }



    // SINT.loader.add('s1', './assets/sound/s1.mp3');
    // SINT.loader.load(function(loader, resources) {
    //     // var s1 = SINT.loader.resources['s1'].sound;
    //     var s1 = resources['s1'].sound;
    //     s1.loop = true;
    //     s1.play();
    // });

    // SINT.Sound.from({
    //     url: 'assets/sound/s2.mp3',
    //     autoPlay: true,
    //     // loop:true,
    //     loaded: function() {
    //         console.log('Sound loaded');
    //     },
    //     complete: function() {
    //         console.log('Sound finished');
    //     }
    // });


    // var videoContainer = document.querySelector('#videoContainer');
    // var video1 = new SINT.VideoDom({ parentElement: videoContainer, videoUrl: './assets/video/dino.mp4', posterImg: './assets/video/dino.jpg' });
    // video1.videoElement.addEventListener('click', function() {
    //     // video1.destroy();
    //     video1.toPlay();
    // });
    // document.querySelector('#videoInput').addEventListener('click', function() {
    //     if(!video1)return;
    //     video1.destroy();
    //     video1 = null;
    // });
    // video1.on('ended',function(e){
    //     video1.destroy();
    //     video1 = null;
    // })


    document.querySelector('#videoInput').addEventListener('click', function() {
        var contentDom = document.createElement('div');
        contentDom.innerHTML = 'changewater3';
        document.body.appendChild(contentDom);
        selectText(contentDom)
        document.execCommand("copy");
        console.log('复制成功');
        document.body.removeChild(contentDom);
    });
    function selectText(x) {
        if (document.selection) {
            var range = document.body.createTextRange();
            range.moveToElementText(x);
            range.select();
        } else if (window.getSelection) {
            var selection = window.getSelection();
            var range = document.createRange();
            selection.removeAllRanges();
            range.selectNodeContents(x);
            selection.addRange(range);
        }
    }



    try {
        console.log(SINT);

        var game = new SINT.Game(config);

        var loadingTxt = new SINT.TextClip(game.initWidth / 2, 600, '0%', {
            fontFamily: 'Arial',
            fontSize: 42,
            fontWeight: 'bold',
            fill: ['#d2497d', '#5a7cd3']
        })
        loadingTxt.anchor.set(0.5)
        game.add(loadingTxt)

        game.preload({
            assets: assets1,
            loading: loading,
            loaded: create,
        })

        function loading(_pr) {
            console.log("loading1_" + _pr)
            loadingTxt.text = _pr + '%'
        }

        function removeLoading() {
            SINT.Tween.to(loadingTxt, 0.6, {
                alpha: 0,
                ease: Strong.easeOut,
                onComplete: function() {
                    game.remove(loadingTxt)
                }
            })
        }

        function create() {
            removeLoading();


            //bg sound
            game.playSound('sound0', true);

            //bg image
            var bg = new SINT.SpriteClip(0, 0, 'bg');
            game.add(bg);

            //Container
            var fishsContainer = new SINT.Container();
            game.add(fishsContainer);
            SINT.Magic.doTwistFilter(fishsContainer, [500, 500], 400, 2, false);

            var fishs = [];
            for (var i = 0; i < 1000; i++) {
                var id = 'fish' + ((i % 4) + 1);
                var fish = new SINT.SpriteClip(0, 0, id);
                fish.tint = Math.random() * 0xff3300;
                fish.alpha = 0.3 + Math.random() * 0.8;
                fish.anchor.set(0.5);
                fish.scale.set(0.2 + Math.random() * 0.2);
                // scatter them all
                fish.x = Math.random() * game.initWidth;
                fish.y = Math.random() * game.initHeight;

                fish.direction = Math.random() * Math.PI * 2;
                fish.turningSpeed = Math.random() - 0.8;
                fish.speed = (2 + Math.random() * 2) * 2;
                fish.offset = Math.random() * 100;
                fishs.push(fish);
                fishsContainer.addChild(fish);
            }

            //btn
            var btn1 = new SINT.SpriteClip(288, 292, 'pic1');
            game.add(btn1);
            btn1.anchor.set(0.5);
            btn1.interactive = true;
            btn1.on('pointerdown', function() {
                SINT.Tween.to(btn1.scale, .6, {
                    x: 1.2,
                    y: 1.2,
                    ease: Elastic.easeOut,
                    onComplete: function() {
                        SINT.Tween.to(btn1.scale, .4, {
                            x: 1,
                            y: 1,
                        });
                        ///////////////////
                        initPart2();

                        SINT.Magic.doTwistFilter(game.stage, [400, 800], 600, 2, true);
                        // SINT.Magic.doRadialBlurFilter(game.stage, [400, 800], 800, 3, true);
                    }
                });
                game.stopAllSound();
            })




            var fishBounds = new PIXI.Rectangle(-100, -100,
                game.initWidth + 100 * 2, game.initHeight + 100 * 2);

            //update
            game.ticker.add(function() {
                //fish
                for (var i = 0; i < fishs.length; i++) {
                    var fish = fishs[i];
                    fish.direction += fish.turningSpeed * 0.01;
                    fish.x += Math.sin(fish.direction) * (fish.speed * fish.scale.y);
                    fish.y += Math.cos(fish.direction) * (fish.speed * fish.scale.y);
                    fish.rotation = -fish.direction - Math.PI / 2;

                    // wrap the maggots
                    if (fish.x < fishBounds.x) {
                        fish.x += fishBounds.width;
                    } else if (fish.x > fishBounds.x + fishBounds.width) {
                        fish.x -= fishBounds.width;
                    }
                    if (fish.y < fishBounds.y) {
                        fish.y += fishBounds.height;
                    } else if (fish.y > fishBounds.y + fishBounds.height) {
                        fish.y -= fishBounds.height;
                    }
                }
            });
        }
        var part2 = false;

        function initPart2() {
            if (part2) return;
            part2 = true;
            game.preload({
                assets: assets2,
                loading: function(_pr) {
                    console.log("loading2_" + _pr)
                },
                loaded: createPart2,
            })
        }

        function createPart2() {
            //btn
            var btn2 = new SINT.SpriteClip(28, 900, 'pic2');
            btn2.addChild(new SINT.TextClip(180, 56, '卸载'));
            game.add(btn2);
            btn2.interactive = true;
            btn2.on('pointerdown', function() {
                game.removeThis();
            })

            //icon1
            var icon1 = new SINT.SpriteClip(28, 1100, 'icon1');
            game.add(icon1);
            var icon2 = new SINT.SpriteClip(228, 1100, 'icon1');
            game.add(icon2);

            SINT.Magic.doDye(icon2, 0x7067c5);

            //Text
            var t1 = new SINT.TextClip(30, 600, 'Game1 * -> 课前游戏 -> 单词文本', {
                fontFamily: 'Arial',
                fontSize: 50,
                fontStyle: 'italic',
                fontWeight: 'bold',
                fill: ['#ffffff', '#00ff99'], // gradient
                stroke: '#4a1850',
                strokeThickness: 5,
                dropShadow: true,
                dropShadowColor: '#000000',
                dropShadowBlur: 4,
                dropShadowAngle: Math.PI / 6,
                dropShadowDistance: 6,
                wordWrap: true,
                wordWrapWidth: 400
            });
            game.add(t1);




            //Animated
            var ac1 = new SINT.AnimatedClip(400, 600, 'fighter');
            game.add(ac1);
            ac1.anchor.set(0.5);
            ac1.animationSpeed = 40 / 60;;
            ac1.interactive = true;
            ac1.on('pointerdown', function() {
                console.log("fly")
                ac1.play();
                SINT.Tween.to(ac1, 1, {
                    y: -150,
                    ease: Strong.easeOut,
                    onComplete: function() {
                        ac1.y = game.initHeight;
                    }
                });
                SINT.Tween.to(ac1, 2, {
                    y: 600,
                    delay: 1,
                    ease: Strong.easeInOut,
                    onComplete: function() {
                        ac1.stop();
                    }
                });


                SINT.Magic.doDye(ac1, 0x00ff00);

                game.playSound('sound1');
                game.pauseSound('sound0');
            })



            // //spine
            // var spineBoy = new SINT.SpineClip(game.initWidth / 2, game.initHeight, 'spineboy');
            // game.add(spineBoy);
            // spineBoy.play('walk');
            // spineBoy.interactive = true;
            // spineBoy.on('pointerdown', function() {
            //     spineBoy.play('jump', false);
            //     spineBoy.state.addAnimation(0, 'walk', true);
            //     //
            //     // game.playSound('sound2');
            // });
        }


        game.stage.interactive = true
        game.stage
            .on('pointerdown', onDragStart)
            .on('pointerup', onDragEnd)
            .on('pointerupoutside', onDragEnd)
            .on('pointermove', onDragMove)

        var mouseFilter = new SINT.Magic.BulgePinchFilter([0.5, 0.5], 300, 1.2);

        function onDragStart(event) {
            this.dragging = true
            game.stage.filters = [mouseFilter];
            mouseFilter.center = [event.data.global.x / 750, event.data.global.y / 1334];
        }

        function onDragEnd(event) {
            this.dragging = false
            SINT.Tween.to(mouseFilter, .3, {
                radius: 0,
            });
        }

        function onDragMove(event) {
            if (this.dragging) {
                mouseFilter.center = [event.data.global.x / 750, event.data.global.y / 1334];
                mouseFilter.radius += (300 - mouseFilter.radius) * 0.8;
            }
        }

    } catch (e) {
        alert(e.message)
    }
    </script>
</body>

</html>